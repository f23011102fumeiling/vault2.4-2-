# 学生端问卷提交功能测试指南

## 修复内容

已在以下文件中添加详细日志，帮助诊断学生端问卷提交问题：

1. **后端学生提交接口**：`backend/app/api/student/survey.py`
   - 添加了完整的提交流程日志
   - 记录每个步骤的执行状态

2. **后端教师查询接口**：`backend/app/api/teacher/survey.py`
   - 添加了查询结果的详细日志
   - 记录查询到的提交记录数量和详情

## 测试步骤

### 1. 学生端提交测试

#### 步骤 1：学生登录
- 使用学生账号登录系统
- 确保学生账号已加入至少一个班级

#### 步骤 2：找到已发布的问卷
- 进入"问卷测验"页面
- 选择"课程检测"、"课后作业"或"自主练习"标签
- 找到一个状态为"可作答"的问卷

#### 步骤 3：完成问卷
- 点击"开始答题"
- 完成所有题目
- 点击"提交答卷"

#### 步骤 4：查看后端日志
在后端控制台（终端 3）中，应该看到以下日志：

```
======================================================================
📝 学生提交问卷 - 开始
问卷ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
学生ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
学生角色: student
提交答案数量: 5
======================================================================
✅ 权限验证通过
✅ 问卷验证通过: 问卷标题
📚 学生所在班级: ['班级ID1', '班级ID2']
✅ 班级权限验证通过
📊 已有提交记录: 否
✅ 多次提交检查通过
✅ 创建提交记录: response_id=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx, attempt_number=1
✅ 保存答案记录: 5 个答案, 总分: 40
📊 计算得分: total_score=40, percentage_score=80.0, is_passed=True
✅ 数据库提交成功
======================================================================
🎉 问卷提交完成
======================================================================
```

### 2. 教师端查看测试

#### 步骤 1：教师登录
- 使用教师账号登录系统
- 确保教师是发布该问卷的老师

#### 步骤 2：找到对应的问卷
- 进入"问卷管理"页面
- 找到学生刚刚提交的问卷

#### 步骤 3：查看统计
- 点击问卷的"查看统计"按钮
- 查看统计弹窗中的"总提交数"

#### 步骤 4：查看后端日志
在后端控制台（终端 3）中，应该看到以下日志：

```
======================================================================
📊 教师查询问卷结果 - 开始
问卷ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
======================================================================
✅ 找到问卷: 问卷标题
📊 查询到的提交记录数: 1
  - response_id=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx, student_id=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx, status=completed, total_score=40
📝 问卷题目数: 5
📊 统计结果: total_responses=1, avg_score=40.0, pass_count=1
✅ 查询成功: totalResponses=1
======================================================================
```

## 问题诊断

### 如果学生提交失败

#### 检查后端日志中的错误信息：

1. **权限验证失败**
   ```
   ❌ 权限验证失败：用户角色不是学生
   ```
   - 解决方案：确保使用学生账号登录

2. **问卷验证失败**
   ```
   ❌ 问卷验证失败：问卷不存在或未发布
   ```
   - 解决方案：确保问卷已发布

3. **班级权限验证失败**
   ```
   ❌ 班级权限验证失败：学生不在目标班级中
   ```
   - 解决方案：确保学生已加入目标班级

4. **多次提交检查失败**
   ```
   ❌ 多次提交检查失败：不允许多次作答
   ```
   - 解决方案：这是正常行为，问卷不允许多次提交

### 如果教师端看不到提交记录

#### 检查后端日志：

1. **查询到的提交记录数为 0**
   ```
   📊 查询到的提交记录数: 0
   ```
   - 可能原因：
     - 学生提交时出现错误
     - 数据库事务未提交成功
     - survey_id 不匹配

2. **查询到的提交记录数 > 0，但前端显示为 0**
   - 可能原因：
     - 前端 API 调用失败
     - 前端数据处理错误

### 检查数据库记录

如果后端日志显示提交成功，但教师端看不到记录，可以直接查询数据库：

```sql
-- 查询 survey_responses 表
SELECT 
    id,
    survey_id,
    student_id,
    attempt_number,
    total_score,
    status,
    submit_time
FROM survey_responses
WHERE survey_id = 'your_survey_id'
ORDER BY submit_time DESC;

-- 查询 answers 表
SELECT 
    a.id,
    a.response_id,
    a.question_id,
    a.student_answer,
    a.is_correct,
    a.score,
    sr.student_id
FROM answers a
JOIN survey_responses sr ON a.response_id = sr.id
WHERE sr.survey_id = 'your_survey_id'
ORDER BY a.id;
```

## 常见问题

### Q1: 学生提交成功，但教师端看不到提交记录

**可能原因**：
1. 数据库事务未正确提交
2. survey_id 不匹配
3. 学生身份验证失败
4. 班级权限验证失败

**解决方案**：
1. 查看后端日志，确认提交是否成功
2. 直接查询数据库，确认记录是否存在
3. 检查学生是否在目标班级中
4. 检查问卷是否已发布

### Q2: 学生无法提交问卷

**可能原因**：
1. 问卷未发布
2. 学生不在目标班级中
3. 问卷不允许多次提交，学生已经提交过

**解决方案**：
1. 确保问卷已发布
2. 确保学生已加入目标班级
3. 检查问卷设置，确认是否允许多次提交

### Q3: 教师端查询时出现错误

**可能原因**：
1. 问卷不存在
2. 数据库连接问题
3. 查询逻辑错误

**解决方案**：
1. 确保问卷存在
2. 检查数据库连接
3. 查看后端日志中的错误信息

## 下一步

1. 按照测试步骤进行测试
2. 查看后端日志，确认每个步骤是否正常
3. 如果出现问题，根据日志信息进行诊断
4. 如果无法解决，提供完整的后端日志和错误信息

## 联系支持

如果问题仍然存在，请提供以下信息：
1. 完整的后端日志
2. 数据库查询结果
3. 前端浏览器控制台错误信息
4. 具体的操作步骤
