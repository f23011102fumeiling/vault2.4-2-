# 学生端问卷提交到数据库流程分析

## 问题描述
学生端问卷作答完成后，教师端没有收到完成的提交记录。

## 完整提交流程分析

### 1. 前端提交代码
**文件**: `e:\2.4\Vault\frontend\src\pages\student\Survey\Take.tsx`

**提交逻辑**:
```typescript
const handleSubmit = async () => {
  try {
    await studentSurveyApi.submitSurvey(surveyId, answers)
    alert('提交成功')
    navigate(`/student/survey/${surveyId}/detail`, { replace: true })
  } catch (e: any) {
    alert(e.response?.data?.detail || e.message || '提交失败')
  }
}
```

**API 调用**:
```typescript
submitSurvey: async (surveyId: string, answers: Record<string, any>) => {
  return apiClient.post(`/student/surveys/${surveyId}/submit`, { answers })
}
```

### 2. 后端接收代码
**文件**: `e:\2.4\Vault\backend\app\api\student\survey.py`

**接口**: `POST /student/surveys/{survey_id}/submit`

**关键逻辑**:

#### 2.1 身份验证
```python
if getattr(current_user, "role", None) != "student":
    raise HTTPException(status_code=403, detail="只有学生可以访问此接口")
```

#### 2.2 问卷验证
```python
survey = db.query(SurveyModel).filter(SurveyModel.id == survey_id).first()
if not survey or survey.status != "published":
    raise HTTPException(status_code=404, detail="问卷不存在或未发布")
```

#### 2.3 班级权限验证
```python
class_ids = _get_student_class_ids(db, str(current_user.id))
target_ids = getattr(survey, "target_class_ids", None) or []
legacy_class_id = getattr(survey, "class_id", None)
visible = (target_ids and any(str(cid) in class_ids for cid in (target_ids if isinstance(target_ids, list) else []))) or (
    legacy_class_id and str(legacy_class_id) in class_ids
)
if not visible:
    raise HTTPException(status_code=404, detail="问卷不存在或未发布")
```

#### 2.4 多次提交检查
```python
if not survey.allow_multiple_attempts:
    if existing:
        raise HTTPException(
            status_code=400,
            detail="该问卷不允许多次作答，您已经提交过了"
        )
else:
    existing_attempts = db.query(SurveyResponseModel).filter(
        SurveyResponseModel.survey_id == survey_id,
        SurveyResponseModel.student_id = sid,
    ).count()
    if existing_attempts >= survey.max_attempts:
        raise HTTPException(
            status_code=400,
            detail=f"您已达到最大作答次数（{survey.max_attempts}次）"
        )
```

#### 2.5 创建提交记录
```python
resp = SurveyResponseModel(
    survey_id=UUID(survey_id),
    student_id=sid,
    attempt_number=attempt,
    status="completed",  # ⚠️ 状态设置为 "completed"
    submit_time=datetime.utcnow(),
)
db.add(resp)
db.flush()
```

#### 2.6 保存答案并计算分数
```python
answers = submission.answers or {}
total_score = 0
for qid, ans in answers.items():
    question = db.query(QuestionModel).filter(
        QuestionModel.id == UUID(qid)
    ).first()
    
    if not question:
        continue
    
    is_correct = False
    score = 0
    
    # 自动评分逻辑
    if question.question_type in ['single_choice', 'judgment']:
        correct_answer = question.correct_answer
        if correct_answer:
            if isinstance(correct_answer, list):
                is_correct = ans in correct_answer
            else:
                is_correct = ans == correct_answer
            if is_correct:
                score = float(question.score)
    elif question.question_type == 'multiple_choice':
        correct_answer = question.correct_answer
        if correct_answer and isinstance(ans, list):
            if isinstance(correct_answer, list):
                is_correct = set(ans) == set(correct_answer)
            else:
                is_correct = ans == correct_answer
            if is_correct:
                score = float(question.score)
    
    total_score += score
    
    a = AnswerModel(
        response_id=resp.id,
        question_id=UUID(qid),
        student_answer=ans,
        is_correct=is_correct,
        score=score,
        auto_graded=True,
    )
    db.add(a)

resp.total_score = total_score
resp.percentage_score = (total_score / survey.total_score * 100) if survey.total_score > 0 else 0
resp.is_passed = resp.percentage_score >= survey.pass_score if survey.pass_score else None

db.commit()  # ⚠️ 提交到数据库
```

### 3. 数据库存储结构
**文件**: `e:\2.4\Vault\backend\app\models\survey.py`

#### 3.1 SurveyResponse 表（提交记录表）
```python
class SurveyResponse(Base):
    __tablename__ = "survey_responses"
    
    id = Column(UUID(as_uuid=True), primary_key=True)
    survey_id = Column(UUID(as_uuid=True), ForeignKey("surveys.id"), nullable=False, index=True)
    student_id = Column(UUID(as_uuid=True), ForeignKey("users.id"), nullable=False, index=True)
    attempt_number = Column(Integer, nullable=False, default=1)
    total_score = Column(DECIMAL(5, 2))
    percentage_score = Column(DECIMAL(5, 2))
    is_passed = Column(Boolean)
    status = Column(String(20), nullable=False, default='in_progress', index=True)  # ⚠️ 默认 'in_progress'
    start_time = Column(DateTime, default=datetime.utcnow, nullable=False)
    submit_time = Column(DateTime)
    time_spent = Column(Integer)  # 秒
    ip_address = Column(String(50))
    user_agent = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
```

#### 3.2 Answer 表（答案表）
```python
class Answer(Base):
    __tablename__ = "answers"
    
    id = Column(UUID(as_uuid=True), primary_key=True)
    response_id = Column(UUID(as_uuid=True), ForeignKey("survey_responses.id"), nullable=False, index=True)
    question_id = Column(UUID(as_uuid=True), ForeignKey("questions.id"), nullable=False, index=True)
    student_answer = Column(JSONB)
    is_correct = Column(Boolean)
    score = Column(DECIMAL(5, 2), default=0)
    teacher_comment = Column(Text)
    auto_graded = Column(Boolean, default=False, nullable=False)
    graded_by = Column(UUID(as_uuid=True), ForeignKey("users.id"))
    graded_at = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
```

### 4. 教师端获取结果代码
**文件**: `e:\2.4\Vault\backend\app\api\teacher\survey.py`

**接口**: `GET /teacher/surveys/{survey_id}/results`

**查询逻辑**:
```python
@router.get("/{survey_id}/results")
async def get_survey_results(survey_id: str, db: Session = Depends(get_db)):
    from app.models.survey import SurveyResponse, Answer
    
    survey = db.query(Survey).filter(Survey.id == survey_id).first()
    if not survey:
        raise HTTPException(status_code=404, detail="问卷不存在")
    
    # ⚠️ 查询条件：status == 'completed'
    responses = db.query(SurveyResponse).filter(
        SurveyResponse.survey_id == survey_id,
        SurveyResponse.status == 'completed'  # ⚠️ 只查询 'completed' 状态
    ).all()
    
    # 获取所有题目
    questions = db.query(Question).filter(
        Question.survey_id == survey_id
    ).order_by(Question.question_order).all()
    
    # 统计数据
    total_responses = len(responses)
    avg_score = 0
    pass_count = 0
    
    if total_responses > 0:
        total_scores = sum(r.total_score or 0 for r in responses)
        avg_score = total_scores / total_responses
        pass_count = sum(1 for r in responses if r.is_passed)
    
    # 统计每道题的答题情况
    question_stats = []
    for q in questions:
        answers = db.query(Answer).join(SurveyResponse).filter(
            SurveyResponse.survey_id == survey_id,
            Answer.question_id == q.id
        ).all()
        
        # ... 统计逻辑
    
    return {
        "surveyId": str(survey.id),
        "title": survey.title,
        "totalResponses": total_responses,
        "avgScore": round(avg_score, 2),
        "passCount": pass_count,
        "passRate": round((pass_count / total_responses * 100), 2) if total_responses > 0 else 0,
        "questionStats": question_stats
    }
```

### 5. 前端教师端显示代码
**文件**: `e:\2.4\Vault\frontend\src\pages\teacher\Survey\index.tsx`

**获取统计**:
```typescript
const handleStats = async (surveyId: string) => {
  try {
    const data = await surveyApi.getSurveyResults(surveyId)
    setStatsData(data)
    setShowStatsModal(true)
  } catch (error: any) {
    console.error('获取统计数据失败:', error)
    alert(error.response?.data?.detail || '获取统计数据失败')
  }
}
```

**显示统计**:
```typescript
<div className="text-3xl font-bold text-blue-700">{statsData.totalResponses}</div>
```

## 问题分析

### 可能的原因

#### 1. ✅ 状态匹配正确
- 学生提交时：`status = "completed"`
- 教师查询时：`status == 'completed'`
- **结论**：状态匹配正确，不是这个问题

#### 2. ⚠️ 数据库事务问题
- 学生提交时使用了 `db.commit()`，理论上应该已经提交到数据库
- 但可能存在以下情况：
  - 事务未正确提交
  - 数据库连接问题
  - 提交过程中出现异常但被捕获
- **建议**：检查后端日志，确认是否有提交成功的日志

#### 3. ⚠️ survey_id 不匹配
- 学生提交的 survey_id 和教师查询的 survey_id 必须完全一致
- 可能的问题：
  - 前端传递的 survey_id 格式不正确
  - UUID 转换问题
- **建议**：检查前端传递的 survey_id 是否正确

#### 4. ⚠️ 学生身份验证问题
- 学生提交时需要通过 `get_current_user` 验证身份
- 如果学生身份验证失败，提交会被拒绝
- **建议**：检查学生登录状态和 JWT token

#### 5. ⚠️ 问卷状态问题
- 学生只能提交 status = 'published' 的问卷
- 如果问卷未发布，学生无法提交
- **建议**：检查问卷是否已发布

#### 6. ⚠️ 班级匹配问题
- 学生只能提交发布到自己班级的问卷
- 如果学生不在目标班级中，无法提交
- **建议**：检查学生是否在目标班级中

#### 7. ⚠️ 数据库表结构问题
- 检查 `survey_responses` 表是否存在
- 检查外键约束是否正确
- **建议**：检查数据库表结构

## 调试建议

### 1. 检查后端日志
```bash
# 查看后端日志，确认学生提交是否成功
# 查找以下日志：
# - "问卷提交成功"
# - "✅ 问卷提交成功"
```

### 2. 检查数据库
```sql
-- 查询 survey_responses 表
SELECT * FROM survey_responses WHERE survey_id = 'your_survey_id';

-- 查询 answers 表
SELECT a.*, sr.student_id, sr.survey_id 
FROM answers a 
JOIN survey_responses sr ON a.response_id = sr.id 
WHERE sr.survey_id = 'your_survey_id';
```

### 3. 检查学生提交时的错误
```javascript
// 在前端 Take.tsx 中添加更详细的错误日志
console.log('提交问卷:', surveyId, answers)
console.log('提交结果:', result)
console.log('提交错误:', error)
```

### 4. 检查后端提交逻辑
```python
# 在 backend/app/api/student/survey.py 的 submit_survey 函数中添加日志
print(f"学生提交问卷: survey_id={survey_id}, student_id={sid}")
print(f"提交答案数量: {len(answers)}")
print(f"创建提交记录: response_id={resp.id}")
print(f"提交记录状态: {resp.status}")
print(f"提交记录分数: {resp.total_score}")
db.commit()
print(f"✅ 问卷提交成功并保存到数据库")
```

### 5. 检查教师端查询
```python
# 在 backend/app/api/teacher/survey.py 的 get_survey_results 函数中添加日志
print(f"教师查询问卷结果: survey_id={survey_id}")
print(f"查询到的提交记录数: {len(responses)}")
for r in responses:
    print(f"  - response_id={r.id}, student_id={r.student_id}, status={r.status}")
```

## 验证步骤

1. **学生端提交测试**
   - 学生登录
   - 找到已发布的问卷
   - 完成问卷并提交
   - 检查前端是否显示"提交成功"

2. **后端日志检查**
   - 查看后端控制台日志
   - 确认是否有提交成功的日志
   - 检查是否有错误信息

3. **数据库验证**
   - 连接到 PostgreSQL 数据库
   - 查询 `survey_responses` 表
   - 确认是否有新的提交记录

4. **教师端查看**
   - 教师登录
   - 找到对应的问卷
   - 点击"查看统计"
   - 检查是否显示提交记录

## 可能的修复方案

### 方案1：添加详细日志
在后端提交和查询函数中添加详细日志，帮助定位问题。

### 方案2：检查数据库连接
确保数据库连接正常，事务能够正确提交。

### 方案3：验证 survey_id
在提交和查询时验证 survey_id 的格式和正确性。

### 方案4：检查外键约束
确保 `survey_responses` 表的外键约束正确，不会导致插入失败。

### 方案5：添加错误处理
在后端提交函数中添加更详细的错误处理和日志记录。

## 结论

根据代码分析，学生端问卷提交到数据库的流程看起来是正确的：
- 前端正确调用 API
- 后端正确接收并处理
- 数据库正确存储
- 教师端正确查询

**最可能的问题**：
1. 数据库事务未正确提交
2. survey_id 不匹配
3. 学生身份验证失败
4. 班级权限验证失败

**建议**：
1. 添加详细日志
2. 检查数据库记录
3. 验证学生权限
4. 检查问卷发布状态
